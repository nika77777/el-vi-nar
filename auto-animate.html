<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Эль Ви-Нар — автоматическое прорисовывание</title>

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    body { margin: 0; overflow: hidden; background: #030720; }

    #starCanvas {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      display: block;
    }

    .overlay {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      pointer-events: none;
    }

    .glyphWrap {
      width: min(92vw, 2in);
      max-width: 2in;
      padding: 36px; /* запас под свечение/лучи, чтобы не обрезалось */
      overflow: visible;
    }

    svg { width: 100%; height: auto; display: block; overflow: visible; }

    /* Плавное появление всей плазмы из “бездны” */
    #plasmaVisual { opacity: 0; }

    /* Иконки-звёзды скрываем (они только маркеры координат) */
    #starsIcon { opacity: 0; }

    /* Реалистичные звёзды */
    #starsReal .rstar {
      opacity: 0;
      transition: opacity 700ms ease;
      filter: url(#starGlow);
    }
    #starsReal .rstar.on { opacity: 1; }

    /* Энергоимпульс: только в конце */
    #impulseReal {
      opacity: 0;
      transition: opacity 900ms ease, transform 900ms ease;
      transform-box: fill-box;
      transform-origin: center;
      filter: url(#impulseGlow);
    }
    #impulseReal.on {
      opacity: 1;
      transform: scale(1.10);
    }

    /* “бегущий огонёк” по плазме */
    #runner {
      opacity: 0;
      transition: opacity 350ms ease;
      filter: url(#runnerGlow);
    }
    #runner.on { opacity: 1; }
  </style>
</head>

<body>
  <canvas id="starCanvas"></canvas>

  <div class="overlay">
    <div class="glyphWrap">
      <svg id="glyphSvg"
           viewBox="0 0 17.471024 31.41024"
           xmlns="http://www.w3.org/2000/svg">

        <defs>
          <!-- Плазма: тонкая текстура края (очень мягкая) -->
          <filter id="plasmaFilter" x="-120%" y="-120%" width="340%" height="340%">
            <feTurbulence id="plasmaNoise"
              type="fractalNoise"
              baseFrequency="0.85"
              numOctaves="2"
              seed="2"
              result="noise"/>
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="0.18" xChannelSelector="R" yChannelSelector="G" result="displaced"/>
            <feGaussianBlur in="displaced" stdDeviation="0.10" result="blur1"/>
            <feMerge>
              <feMergeNode in="blur1"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>

          <!-- Мягкое свечение плазмы -->
          <filter id="plasmaGlow" x="-160%" y="-160%" width="420%" height="420%">
            <feGaussianBlur stdDeviation="0.40" result="b"/>
            <feMerge>
              <feMergeNode in="b"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>

          <!-- Белая плазма с лёгким ледяным оттенком -->
          <linearGradient id="plasmaGrad" x1="0" y1="0" x2="1" y2="0">
            <stop offset="0%"   stop-color="#ffffff" stop-opacity="0.90"/>
            <stop offset="45%"  stop-color="#eef9ff" stop-opacity="1"/>
            <stop offset="55%"  stop-color="#ffffff" stop-opacity="0.96"/>
            <stop offset="100%" stop-color="#ffffff" stop-opacity="0.88"/>
          </linearGradient>

          <!-- Звезда: ядро -->
          <radialGradient id="starCoreGrad">
            <stop offset="0%"   stop-color="#ffffff" stop-opacity="1"/>
            <stop offset="30%"  stop-color="#ffffff" stop-opacity="0.95"/>
            <stop offset="70%"  stop-color="#cfeaff" stop-opacity="0.40"/>
            <stop offset="100%" stop-color="#a7d8ff" stop-opacity="0"/>
          </radialGradient>

          <filter id="starGlow" x="-260%" y="-260%" width="620%" height="620%">
            <feGaussianBlur stdDeviation="0.26" result="b"/>
            <feMerge>
              <feMergeNode in="b"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>

          <filter id="impulseGlow" x="-320%" y="-320%" width="740%" height="740%">
            <feGaussianBlur stdDeviation="0.34" result="b"/>
            <feMerge>
              <feMergeNode in="b"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>

          <filter id="runnerGlow" x="-400%" y="-400%" width="900%" height="900%">
            <feGaussianBlur stdDeviation="0.24" result="b"/>
            <feMerge>
              <feMergeNode in="b"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>

        <!-- Координаты Inkscape -->
        <g id="layer1" transform="translate(-161.76484,-11.295264)">

          <!-- Иконки-звёзды (маркеры) -->
          <g id="starsIcon" pointer-events="none">
            <path id="star6" d="m 113.98988,239.23457 -1.0641,-0.31796 -0.25668,1.08051 -0.25669,-1.08051 -1.06409,0.31796 0.80741,-0.76255 -0.80741,-0.76256 1.06409,0.31796 0.25669,-1.08051 0.25668,1.08051 1.0641,-0.31796 -0.80741,0.76256 z" transform="matrix(-0.21646536,0.37465133,-0.37492902,-0.21630505,292.43213,39.873066)" />
            <path id="star3" d="m 113.98988,239.23457 -1.0641,-0.31796 -0.25668,1.08051 -0.25669,-1.08051 -1.06409,0.31796 0.80741,-0.76255 -0.80741,-0.76256 1.06409,0.31796 0.25669,-1.08051 0.25668,1.08051 1.0641,-0.31796 -0.80741,0.76256 z" transform="matrix(-0.21646536,0.37465133,-0.37492902,-0.21630505,288.85562,29.186314)" />
            <path id="star4" d="m 113.98988,239.23457 -1.0641,-0.31796 -0.25668,1.08051 -0.25669,-1.08051 -1.06409,0.31796 0.80741,-0.76255 -0.80741,-0.76256 1.06409,0.31796 0.25669,-1.08051 0.25668,1.08051 1.0641,-0.31796 -0.80741,0.76256 z" transform="matrix(-0.21646536,0.37465133,-0.37492902,-0.21630505,276.16664,39.873066)" />
            <path id="star2" d="m 113.98988,239.23457 -1.0641,-0.31796 -0.25668,1.08051 -0.25669,-1.08051 -1.06409,0.31796 0.80741,-0.76255 -0.80741,-0.76256 1.06409,0.31796 0.25669,-1.08051 0.25668,1.08051 1.0641,-0.31796 -0.80741,0.76256 z" transform="matrix(-0.21646536,0.37465133,-0.37492902,-0.21630505,279.74315,29.186314)" />
            <path id="star1" d="m 113.98988,239.23457 -1.0641,-0.31796 -0.25668,1.08051 -0.25669,-1.08051 -1.06409,0.31796 0.80741,-0.76255 -0.80741,-0.76256 1.06409,0.31796 0.25669,-1.08051 0.25668,1.08051 1.0641,-0.31796 -0.80741,0.76256 z" transform="matrix(-0.21646536,0.37465133,-0.37492902,-0.21630505,284.29938,21.326142)" />
            <path id="star5" d="m 113.98988,239.23457 -1.00826,-0.35527 0.0822,1.06585 -0.46173,-0.96416 -0.69555,0.81181 0.35527,-1.00826 -1.06585,0.0822 0.96416,-0.46173 -0.8118,-0.69555 1.00826,0.35527 -0.0822,-1.06585 0.46174,0.96416 0.69554,-0.81181 -0.35527,1.00826 1.06586,-0.0822 -0.96416,0.46173 z" transform="matrix(0.20221877,0.75469068,0.75469068,-0.20221877,-32.256065,-9.1313715)" />
          </g>

          <!-- Реалистичные звёзды поверх -->
          <g id="starsReal" pointer-events="none"></g>

          <!-- Реалистичный энергоимпульс (в конце) -->
          <g id="impulseReal" pointer-events="none"></g>

          <!-- Бегущий огонёк -->
          <g id="runner" pointer-events="none"></g>

          <!-- Базовые пути (для длины/точек) -->
          <g id="plasmaGroup">
            <path id="seg1" d="m 170.50035,11.955075 -4.55624,7.860171" fill="none"/>
            <path id="seg2" d="m 165.94411,19.815246 9.11247,-4e-6" fill="none"/>
            <path id="seg3" d="m 175.05658,19.815242 -4.55623,-7.860167" fill="none"/>
            <path id="seg4" d="m 165.94411,19.815248 4.55624,7.860171" fill="none"/>
            <path id="seg5" d="m 170.50035,27.675419 4.55623,-7.860167" fill="none"/>
            <path id="seg6" d="m 162.3676,30.830773 v -3.155354 h 16.26549 v 3.155354" fill="none"/>
            <path id="seg7" d="m 170.50034,27.675419 c 0,0 -0.97185,1.236575 -0.91015,1.958613 0.13716,1.60544 2.75374,2.128038 2.73044,3.917219 -0.0116,0.894587 -0.97083,1.423155 -1.90259,1.953447 -0.93175,0.530292 -1.89099,1.05886 -1.90259,1.953452 -0.0233,1.78918 2.59328,2.311779 2.73045,3.917218 0.0308,0.361018 -0.19669,0.850671 -0.43195,1.250065" fill="none"/>
          </g>

        </g>
      </svg>
    </div>
  </div>

  <script>
  (() => {
    /* ---------- ФОН: тёмно-синий + цветная дымка ---------- */
    const canvas = document.getElementById('starCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });

    const DPR = () => Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    let W = 0, H = 0, dpr = 1;
    const stars = [];
    const STAR_COUNT = 360;

    function rand(min, max) { return min + Math.random() * (max - min); }

    function resizeCanvas() {
      dpr = DPR();
      W = Math.floor(window.innerWidth * dpr);
      H = Math.floor(window.innerHeight * dpr);
      canvas.width = W;
      canvas.height = H;
    }

    function initStars() {
      stars.length = 0;
      for (let i = 0; i < STAR_COUNT; i++) {
        const z = Math.pow(Math.random(), 1.9);
        stars.push({
          x: Math.random(),
          y: Math.random(),
          r: rand(0.18, 1.45) * (0.35 + (1 - z)),
          a: rand(0.16, 1.0),
          tw: rand(0.40, 1.6),
          ph: rand(0, Math.PI * 2),
          cool: Math.random() > 0.52
        });
      }
    }

    function drawNebula(t) {
      const time = t * 0.00010;

      // базовый глубокий синий
      ctx.fillStyle = '#030720';
      ctx.fillRect(0, 0, W, H);

      // облака
      const clouds = [
        { x: 0.52 + 0.03*Math.sin(time*1.2), y: 0.36, r: 0.78, c0: 'rgba(70,120,210,0.18)', c1: 'rgba(3,7,32,0)' },
        { x: 0.32, y: 0.62 + 0.03*Math.cos(time*1.05), r: 0.70, c0: 'rgba(120,90,200,0.12)', c1: 'rgba(3,7,32,0)' },
        { x: 0.74, y: 0.72, r: 0.62, c0: 'rgba(80,170,160,0.10)', c1: 'rgba(3,7,32,0)' },
      ];

      for (const cl of clouds) {
        const g = ctx.createRadialGradient(W*cl.x, H*cl.y, 0, W*cl.x, H*cl.y, Math.min(W,H)*cl.r);
        g.addColorStop(0, cl.c0);
        g.addColorStop(1, cl.c1);
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, W, H);
      }
    }

    function drawStars(t) {
      drawNebula(t);

      const time = t * 0.001;
      for (const s of stars) {
        const x = s.x * W;
        const y = s.y * H;
        const tw = 0.62 + 0.38 * Math.sin(time * s.tw + s.ph);
        const a = s.a * tw;

        const col = s.cool ? `rgba(210,238,255,${a})` : `rgba(255,238,220,${a})`;

        ctx.beginPath();
        ctx.fillStyle = col;
        ctx.arc(x, y, s.r * dpr, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    resizeCanvas();
    initStars();
    window.addEventListener('resize', () => { resizeCanvas(); initStars(); });

    /* ---------- SVG: сегменты + реалистичные звёзды + “бегущий огонёк” ---------- */
    const svg = document.getElementById('glyphSvg');
    const plasmaGroup = svg.querySelector('#plasmaGroup');
    const noise = svg.querySelector('#plasmaNoise');

    const starsIcon = Array.from(svg.querySelectorAll('#starsIcon > path[id^="star"]'));
    const starsRealGroup = svg.querySelector('#starsReal');
    const impulseRealGroup = svg.querySelector('#impulseReal');
    const runnerGroup = svg.querySelector('#runner');

    function iconCenter(el) {
      const b = el.getBBox();
      return { x: b.x + b.width/2, y: b.y + b.height/2 };
    }

    // заранее центры — чтобы iOS не “чудил” во время анимации
    const starCenters = starsIcon.map(s => ({ id: s.id, c: iconCenter(s) }));

    // “реалистичная” звезда: круг-ореол + ядро + 4 луча
    function makeRealStar(id, cx, cy, rOuter, rCore) {
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.setAttribute('class', 'rstar');
      g.setAttribute('data-id', id);

      const halo = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      halo.setAttribute('cx', cx);
      halo.setAttribute('cy', cy);
      halo.setAttribute('r', rOuter);
      halo.setAttribute('fill', 'url(#starCoreGrad)');

      const core = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      core.setAttribute('cx', cx);
      core.setAttribute('cy', cy);
      core.setAttribute('r', rCore);
      core.setAttribute('fill', '#ffffff');
      core.setAttribute('opacity', '0.96');

      // лучи (как на “реалистичных” звёздах)
      const mkRay = (x1,y1,x2,y2,op) => {
        const ln = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        ln.setAttribute('x1', x1); ln.setAttribute('y1', y1);
        ln.setAttribute('x2', x2); ln.setAttribute('y2', y2);
        ln.setAttribute('stroke', '#ffffff');
        ln.setAttribute('stroke-width', '0.12');
        ln.setAttribute('stroke-linecap', 'round');
        ln.setAttribute('opacity', op);
        return ln;
      };

      const rayLen = rOuter * 1.55;
      const ray1 = mkRay(cx - rayLen, cy, cx + rayLen, cy, '0.35');
      const ray2 = mkRay(cx, cy - rayLen, cx, cy + rayLen, '0.35');

      const rayLen2 = rOuter * 1.15;
      const ray3 = mkRay(cx - rayLen2, cy - rayLen2, cx + rayLen2, cy + rayLen2, '0.22');
      const ray4 = mkRay(cx - rayLen2, cy + rayLen2, cx + rayLen2, cy - rayLen2, '0.22');

      g.appendChild(halo);
      g.appendChild(ray1);
      g.appendChild(ray2);
      g.appendChild(ray3);
      g.appendChild(ray4);
      g.appendChild(core);

      return g;
    }

    // создаём все реальные звёзды
    const realStars = new Map(); // id -> element
    for (const s of starCenters) {
      const rOuter = 1.45 + Math.random()*0.55;
      const rCore  = 0.24 + Math.random()*0.10;
      const spr = makeRealStar(s.id, s.c.x, s.c.y, rOuter, rCore);
      starsRealGroup.appendChild(spr);
      realStars.set(s.id, spr);
    }

    function starOnById(id) {
      const el = realStars.get(id);
      if (el) el.classList.add('on');
    }

    function nearestStarId(pt) {
      let best = null;
      let bestD2 = Infinity;
      for (const s of starCenters) {
        const dx = s.c.x - pt.x;
        const dy = s.c.y - pt.y;
        const d2 = dx*dx + dy*dy;
        if (d2 < bestD2) { bestD2 = d2; best = s.id; }
      }
      return best;
    }

    // Энергоимпульс — точка соединения
    const IMP = { x: 170.50035, y: 27.675419 };
    const impulseSprite = makeRealStar('impulse', IMP.x, IMP.y, 2.85, 0.55);
    impulseRealGroup.appendChild(impulseSprite);

    // бегущий огонёк (не огромный, но заметнее)
    const runnerHalo = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    runnerHalo.setAttribute('cx', IMP.x);
    runnerHalo.setAttribute('cy', IMP.y);
    runnerHalo.setAttribute('r', '1.05');
    runnerHalo.setAttribute('fill', 'url(#starCoreGrad)');
    runnerGroup.appendChild(runnerHalo);

    const runnerCore = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    runnerCore.setAttribute('cx', IMP.x);
    runnerCore.setAttribute('cy', IMP.y);
    runnerCore.setAttribute('r', '0.22');
    runnerCore.setAttribute('fill', '#ffffff');
    runnerCore.setAttribute('opacity', '0.95');
    runnerGroup.appendChild(runnerCore);

    function setRunner(pt, on) {
      runnerHalo.setAttribute('cx', pt.x);
      runnerHalo.setAttribute('cy', pt.y);
      runnerCore.setAttribute('cx', pt.x);
      runnerCore.setAttribute('cy', pt.y);
      if (on) runnerGroup.classList.add('on'); else runnerGroup.classList.remove('on');
    }

    /* Плазма */
    const order = ['seg1','seg2','seg3','seg4','seg5','seg6','seg7'];

    function smoothstep(t) { return t * t * (3 - 2 * t); }

    const PRE_DELAY_MS = 750;
    const FADE_IN_MS = 4600;

    // медленно и пропорционально длинам
    const MS_PER_UNIT = 620;
    const MIN_SEG_MS  = 2000;

    function makePlasmaLayers(basePath) {
      const d = basePath.getAttribute('d');
      const baseSW = 0.365878;

      // ВАЖНО: ядро чуть толще, чтобы seg2 (горизонталь) не пропадал
      const outerW = baseSW * 1.22;
      const coreW  = baseSW * 1.10;

      const outer = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      outer.setAttribute('d', d);
      outer.setAttribute('fill', 'none');
      outer.setAttribute('stroke', 'url(#plasmaGrad)');
      outer.setAttribute('stroke-linecap', 'round');
      outer.setAttribute('stroke-linejoin', 'round');
      outer.setAttribute('stroke-width', String(outerW));
      outer.setAttribute('opacity', '0.30');
      outer.setAttribute('filter', 'url(#plasmaGlow)');

      const core = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      core.setAttribute('d', d);
      core.setAttribute('fill', 'none');
      core.setAttribute('stroke', 'url(#plasmaGrad)');
      core.setAttribute('stroke-linecap', 'round');
      core.setAttribute('stroke-linejoin', 'round');
      core.setAttribute('stroke-width', String(coreW));
      core.setAttribute('opacity', '0.98');
      core.setAttribute('filter', 'url(#plasmaFilter)');

      return [outer, core];
    }

    // визуальная группа для плазмы (отдельно от базовых путей)
    const plasmaVisual = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    plasmaVisual.setAttribute('id', 'plasmaVisual');
    plasmaGroup.parentNode.insertBefore(plasmaVisual, plasmaGroup);

    const segments = [];
    for (const id of order) {
      const base = svg.querySelector('#' + CSS.escape(id));
      if (!base) continue;

      const total = base.getTotalLength();
      const layers = makePlasmaLayers(base);

      for (const p of layers) plasmaVisual.appendChild(p);

      base.style.stroke = 'none';
      base.style.fill = 'none';

      for (const p of layers) {
        p.style.strokeDasharray = String(total);
        p.style.strokeDashoffset = String(total);
      }

      segments.push({ id, base, total, layers, starStartDone: false, starEndDone: false });
    }

    // таймлайн по длинам
    let tCursor = PRE_DELAY_MS;
    for (const s of segments) {
      const dur = Math.max(MIN_SEG_MS, s.total * MS_PER_UNIT);
      s.t0 = tCursor;
      s.t1 = tCursor + dur;
      tCursor = s.t1;
    }
    const TOTAL_MS = tCursor + 1800;

    // сброс видимости
    for (const el of realStars.values()) el.classList.remove('on');
    impulseRealGroup.classList.remove('on');
    plasmaVisual.style.opacity = '0';
    setRunner(IMP, false);

    // первая звезда: по началу seg1
    const firstStart = segments[0]?.base.getPointAtLength(0);
    const firstId = firstStart ? nearestStarId(firstStart) : null;

    function animate(ts0) {
      function frame(ts) {
        drawStars(ts);

        const elapsed = ts - ts0;

        // плавное появление плазмы
        const fadeT = Math.max(0, Math.min(1, elapsed / FADE_IN_MS));
        plasmaVisual.style.opacity = String(0.001 + 0.999 * smoothstep(fadeT));

        // мягкая “живость” текстуры плазмы
        if (noise) {
          const t = ts * 0.00022;
          const bf = 0.82 + 0.08 * Math.sin(t);
          noise.setAttribute('baseFrequency', bf.toFixed(3));
        }

        // включаем первую звезду после выхода “из тьмы”
        if (firstId && elapsed > PRE_DELAY_MS + 550) {
          starOnById(firstId);
        }

        // runner видим только когда реально рисуем сегменты
        let runnerActive = false;

        for (const s of segments) {
          let t = 0;
          if (elapsed <= s.t0) t = 0;
          else if (elapsed >= s.t1) t = 1;
          else t = (elapsed - s.t0) / (s.t1 - s.t0);

          const eased = smoothstep(t);
          const drawLen = s.total * eased;
          const offset = s.total - drawLen;

          for (const p of s.layers) p.style.strokeDashoffset = String(offset);

          // двигаем “огонёк” по текущему активному сегменту (делаем заметнее)
          if (t > 0 && t < 1) {
            const pt = s.base.getPointAtLength(drawLen);
            setRunner(pt, true);
            runnerActive = true;
          }

          // звезда старта
          if (t > 0.10 && !s.starStartDone) {
            const pt = s.base.getPointAtLength(0);
            starOnById(nearestStarId(pt));
            s.starStartDone = true;
          }

          // звезда финиша
          if (t > 0.92 && !s.starEndDone) {
            const pt = s.base.getPointAtLength(s.total);
            starOnById(nearestStarId(pt));
            s.starEndDone = true;
          }
        }

        if (!runnerActive) setRunner(IMP, false);

        // энергоимпульс — только финал
        if (elapsed > TOTAL_MS - 1200) {
          impulseRealGroup.classList.add('on');
        }

        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    requestAnimationFrame(animate);
  })();
  </script>
</body>
</html>
