<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Эль Ви-Нар — Диагностический калькулятор</title>

  <style>
    :root { color-scheme: light; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; line-height: 1.35; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    h2 { font-size: 16px; margin: 18px 0 8px; }
    p { margin: 8px 0; }
    .note { font-size: 13px; opacity: 0.85; }
    .card { border: 1px solid rgba(0,0,0,0.12); border-radius: 12px; padding: 12px; margin: 10px 0; }
    .checklist { display: grid; gap: 10px; }
    label { display: flex; gap: 10px; align-items: flex-start; cursor: pointer; }
    input[type="checkbox"] { width: 18px; height: 18px; margin-top: 2px; flex: 0 0 auto; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    button { border: 1px solid rgba(0,0,0,0.15); background: #fff; border-radius: 10px; padding: 10px 12px; cursor: pointer; }
    button:hover { background: rgba(0,0,0,0.03); }
    .small { font-size: 13px; }
    textarea { width: 100%; min-height: 90px; resize: vertical; padding: 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.15); }
    .divider { height: 1px; background: rgba(0,0,0,0.08); margin: 14px 0; }
    .muted { opacity: 0.85; }

    /* Readable Results UI */
    .results-grid { display: grid; gap: 10px; }
    .box { border: 1px solid rgba(0,0,0,0.10); border-radius: 12px; padding: 12px; background: rgba(0,0,0,0.015); }
    .box h3 { margin: 0 0 8px; font-size: 14px; }
    .kpi { display: grid; gap: 6px; font-size: 13px; }
    .kpi-row { display: flex; justify-content: space-between; gap: 12px; }
    .kpi-row strong { font-weight: 600; }
    .tag { display: inline-block; font-size: 12px; padding: 3px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,0.12); background: #fff; }
    .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    ul { margin: 8px 0 0 18px; padding: 0; }
    li { margin: 6px 0; }
    .two-col { display: grid; gap: 10px; }
    @media (min-width: 680px) { .two-col { grid-template-columns: 1fr 1fr; } }

    .plain-output { display: none; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 13px; }

    /* Print / PDF layout */
    @media print {
      body { margin: 0; }
      .wrap { max-width: 100%; padding: 0; }
      .card { border: 0; border-radius: 0; padding: 0; margin: 12px 0; }
      .row, .note.print-hide, .print-hide { display: none !important; }
      textarea { border: 0; padding: 0; min-height: 0; }
      .divider { display: none; }
      label { cursor: default; }
      input[type="checkbox"] { transform: translateY(1px); }
      h1 { font-size: 18px; margin-bottom: 6px; }
      h2 { font-size: 14px; margin: 10px 0 6px; }
      .box { break-inside: avoid; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Диагностика тэттраглифа Эль Ви-Нар — «Заземление»</h1>
    <p class="note">Период наблюдения: последние 3–7 дней. Отмечайте только то, что вы действительно наблюдали, а не то, что «должно быть».</p>

    <div class="card">
      <h2>Часть I. Наблюдения</h2>
      <p class="note">Вопросы намеренно перемешаны. Это помогает отвечать честнее и точнее.</p>
      <div class="checklist" id="part1Mixed"></div>
    </div>

    <div class="card">
      <h2>Часть V. Удержание состояния во времени</h2>
      <p class="note">Под «нагрузкой» понимаются обычные жизненные ситуации: работа, общение, ответственность, усталость, необходимость принимать решения.</p>
      <div class="checklist" id="hold"></div>
    </div>

    <div class="card">
      <h2>Часть VI. Итоговая фиксация</h2>

      <p class="small">Примеры из жизни:</p>
      <textarea id="examples" placeholder="Запишите 2–5 коротких примеров из наблюдений..."></textarea>

      <div class="divider"></div>

      <p class="small">В ближайшие дни я обращаю внимание на:</p>
      <textarea id="next" placeholder="Запишите, на что вы будете обращать внимание в следующие дни..."></textarea>
    </div>

    <div class="row print-hide">
      <button id="calc">Рассчитать</button>
      <button id="reset">Сбросить</button>
      <button id="copy">Скопировать результат</button>
      <button id="pdf">Скачать PDF</button>
    </div>

    <div class="card">
      <h2>Результаты</h2>

      <div class="results-grid" id="resultsUI">
        <div class="box">
          <h3>Пока нет результатов</h3>
          <p class="muted" style="margin:0;">Отметьте пункты и нажмите «Рассчитать».</p>
        </div>
      </div>

      <!-- Plain text version used for Copy -->
      <div class="plain-output" id="plainOut"></div>
    </div>

    <p class="note print-hide">Конфиденциальность: страница не отправляет ответы никуда. Всё рассчитывается только в вашем браузере.</p>
  </div>

<script>
  /*
    Part I items are shuffled on each load.
    We do NOT show any original numbering in the UI.
    Each item has a hidden group for correct scoring.
  */

  const part1Items = [
    { group: "stable",  text: "Внимание удерживается в текущем действии, без необходимости специально себя возвращать." },
    { group: "stable",  text: "В теле большую часть времени ощущается опора без зажима и усилия." },
    { group: "stable",  text: "Я ясно ощущаю факт своего присутствия, без необходимости его подтверждать." },
    { group: "stable",  text: "Я понимаю, что делаю и зачем, без внутреннего шума и противоречивых импульсов." },
    { group: "stable",  text: "Я чувствую своё внутреннее состояние и не теряю с ним контакт, даже когда занят(а) делами." },
    { group: "stable",  text: "Я вижу, что происходит сейчас, и понимаю следующий практический шаг." },
    { group: "stable",  text: "Повседневные ситуации в целом переживаются как выдерживаемые и понятные." },
    { group: "stable",  text: "Присутствие естественно переходит в действия и решения, без разрыва между ощущением и поступком." },

    { group: "shadow",  text: "Внимание часто уходит в прошлое или тревожное будущее." },
    { group: "shadow",  text: "Я замечаю фоновое сканирование угроз или ожидание проблем." },
    { group: "shadow",  text: "Даже в спокойных ситуациях внутри остаётся настороженность." },
    { group: "shadow",  text: "Опора ощущается через напряжение, собранность или контроль." },
    { group: "shadow",  text: "Реальность часто переживается как хаотичная, давящая или небезопасная." },
    { group: "shadow",  text: "Решения принимаются, чтобы быстрее снизить внутреннее напряжение." },
    { group: "shadow",  text: "Я избегаю некоторых шагов, потому что они вызывают внутренний дискомфорт." },

    { group: "falseact", text: "Иногда кажется, что я в опоре, но это состояние быстро рассеивается." },
    { group: "falseact", text: "Чтобы быть устойчивым(ой), мне нужно каждый раз «собираться»." },
    { group: "falseact", text: "Я могу много делать, но при этом не чувствовать присутствия в этих действиях." },
    { group: "falseact", text: "После ощущения устойчивости напряжение или тревога возвращаются." }
  ];

  const holdItems = [
    "Опора ощущается не только в спокойных условиях, но и в повседневной нагрузке.",
    "Внимание остаётся в настоящем даже при усталости или напряжении.",
    "Мне не нужно специально возвращать себя в присутствие, чтобы быть устойчивым(ой).",
    "Действия сохраняют последовательность без внутреннего давления.",
    "Повседневные задачи не выбивают из состояния присутствия."
  ];

  function shuffle(array) {
    const a = array.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function renderPart1Mixed() {
    const root = document.getElementById("part1Mixed");
    root.innerHTML = "";
    const mixed = shuffle(part1Items);
    mixed.forEach((item, idx) => {
      const id = `p1-${idx}-${Math.random().toString(16).slice(2)}`;
      const label = document.createElement("label");
      label.innerHTML =
        `<input type="checkbox" id="${id}" data-group="${item.group}">
         <span>${item.text}</span>`;
      root.appendChild(label);
    });
  }

  function renderHold() {
    const root = document.getElementById("hold");
    root.innerHTML = "";
    holdItems.forEach((text, idx) => {
      const id = `hold-${idx}`;
      const label = document.createElement("label");
      label.innerHTML =
        `<input type="checkbox" id="${id}" data-group="hold">
         <span>${text}</span>`;
      root.appendChild(label);
    });
  }

  renderPart1Mixed();
  renderHold();

  function countGroup(groupId) {
    return [...document.querySelectorAll(`input[data-group="${groupId}"]`)].filter(x => x.checked).length;
  }

  function bandStable(c) {
    if (c >= 6) return "выражено ясно";
    if (c >= 3) return "присутствует частично";
    return "выражено слабо";
  }

  function bandShadow(c) {
    if (c >= 4) return "выражено сильно";
    if (c >= 2) return "проявляется точечно";
    return "почти не проявляется";
  }

  function bandFalse(c) {
    if (c >= 3) return "высокая вероятность";
    if (c >= 1) return "проявляется ситуативно";
    return "почти не проявляется";
  }

  function bandHold(c) {
    if (c >= 4) return "удерживается фоново";
    if (c >= 2) return "активируется осознанно";
    return "удержание слабое";
  }

  function buildTags(stableC, shadowC, falseC, holdC) {
    const tags = [];
    if (stableC >= 6) tags.push("Устойчивое заземление — выражено");
    else if (stableC >= 3) tags.push("Устойчивое заземление — частично");
    else tags.push("Устойчивое заземление — слабее");

    if (shadowC >= 4) tags.push("Теневая динамика — сильнее");
    else if (shadowC >= 2) tags.push("Теневая динамика — точечно");
    else tags.push("Теневая динамика — минимально");

    if (falseC >= 3) tags.push("Ложная активация — вероятна");
    else if (falseC >= 1) tags.push("Ложная активация — ситуативно");
    else tags.push("Ложная активация — минимально");

    if (holdC >= 4) tags.push("Удержание — фоново");
    else if (holdC >= 2) tags.push("Удержание — активируемо");
    else tags.push("Удержание — слабее");

    return tags;
  }

  function setResultsUI(payload) {
    const root = document.getElementById("resultsUI");
    root.innerHTML = "";

    const { stableC, shadowC, falseC, holdC, examples, next, commentary } = payload;

    const tags = buildTags(stableC, shadowC, falseC, holdC);

    const kpiBox = document.createElement("div");
    kpiBox.className = "box";
    kpiBox.innerHTML = `
      <h3>Сводка</h3>
      <div class="kpi">
        <div class="kpi-row"><span>Устойчивое заземление</span><strong>${stableC} / 8</strong></div>
        <div class="kpi-row"><span>Теневая реализация</span><strong>${shadowC} / 7</strong></div>
        <div class="kpi-row"><span>Ложная активация</span><strong>${falseC} / 4</strong></div>
        <div class="kpi-row"><span>Удержание во времени</span><strong>${holdC} / 5</strong></div>
      </div>
      <div class="tags">${tags.map(t => `<span class="tag">${t}</span>`).join("")}</div>
    `;
    root.appendChild(kpiBox);

    const two = document.createElement("div");
    two.className = "two-col";

    const interpret = document.createElement("div");
    interpret.className = "box";
    interpret.innerHTML = `
      <h3>Интерпретация шкал</h3>
      <ul>
        <li><strong>Устойчивое заземление:</strong> ${bandStable(stableC)}.</li>
        <li><strong>Теневая реализация:</strong> ${bandShadow(shadowC)}.</li>
        <li><strong>Ложная активация:</strong> ${bandFalse(falseC)}.</li>
        <li><strong>Удержание:</strong> ${bandHold(holdC)}.</li>
      </ul>
    `;

    const note = document.createElement("div");
    note.className = "box";
    note.innerHTML = `
      <h3>Комментарий из методики</h3>
      <p style="margin:0;">${commentary}</p>
    `;

    two.appendChild(interpret);
    two.appendChild(note);
    root.appendChild(two);

    const textBox = document.createElement("div");
    textBox.className = "box";
    textBox.innerHTML = `
      <h3>Личные заметки</h3>
      <p class="muted" style="margin:0 0 8px;"><strong>Примеры из жизни:</strong><br>${examples || "—"}</p>
      <p class="muted" style="margin:0;"><strong>В ближайшие дни я обращаю внимание на:</strong><br>${next || "—"}</p>
    `;
    root.appendChild(textBox);
  }

  function setPlainText(payload) {
    const { stableC, shadowC, falseC, holdC, examples, next, commentary } = payload;
    const text =
`СВОДКА
Устойчивое заземление: ${stableC} из 8
Теневая реализация: ${shadowC} из 7
Ложная активация: ${falseC} из 4
Удержание во времени: ${holdC} из 5

ИНТЕРПРЕТАЦИЯ
Устойчивое заземление: ${bandStable(stableC)}
Теневая реализация: ${bandShadow(shadowC)}
Ложная активация: ${bandFalse(falseC)}
Удержание: ${bandHold(holdC)}

КОММЕНТАРИЙ
${commentary}

ПРИМЕРЫ ИЗ ЖИЗНИ
${examples || "—"}

ФОКУС НА СЛЕДУЮЩИЕ ДНИ
${next || "—"}
`;
    document.getElementById("plainOut").textContent = text;
  }

  function getCommentary() {
    return "Если одновременно присутствуют элементы устойчивого заземления и тени — это самый частый и самый здоровый вариант. Он означает, что опора уже формируется, но ещё не удерживается одинаково во всех ситуациях. Если присутствуют элементы ложной активации — это указывает на места, где состояние похоже на заземление, но пока не удерживается.";
  }

  document.getElementById("calc").addEventListener("click", () => {
    const stableC = countGroup("stable");
    const shadowC = countGroup("shadow");
    const falseC  = countGroup("falseact");
    const holdC   = countGroup("hold");

    const examples = document.getElementById("examples").value.trim();
    const next = document.getElementById("next").value.trim();

    const payload = {
      stableC, shadowC, falseC, holdC,
      examples, next,
      commentary: getCommentary()
    };

    setResultsUI(payload);
    setPlainText(payload);
  });

  document.getElementById("reset").addEventListener("click", () => {
    document.querySelectorAll('input[type="checkbox"]').forEach(x => x.checked = false);
    document.getElementById("examples").value = "";
    document.getElementById("next").value = "";

    const root = document.getElementById("resultsUI");
    root.innerHTML = `
      <div class="box">
        <h3>Пока нет результатов</h3>
        <p class="muted" style="margin:0;">Отметьте пункты и нажмите «Рассчитать».</p>
      </div>
    `;
    document.getElementById("plainOut").textContent = "";

    renderPart1Mixed(); // перемешать заново
  });

  document.getElementById("copy").addEventListener("click", async () => {
    const t = document.getElementById("plainOut").textContent.trim();
    if (!t) {
      alert("Сначала нажмите «Рассчитать», чтобы появился результат.");
      return;
    }
    try {
      await navigator.clipboard.writeText(t);
      alert("Результат скопирован.");
    } catch {
      alert("Не удалось скопировать автоматически. На iPhone/iPad выделите текст результата и скопируйте вручную.");
    }
  });

  document.getElementById("pdf").addEventListener("click", () => {
    window.print();
  });
</script>
</body>
</html>
